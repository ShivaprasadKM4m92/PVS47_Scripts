var signal=signal||{},meetingDataTable,schedulerDataJson;
signal.meeting_utils=function(){var a,b=function(a,b){var d,f=new FormData;a.find("#meetingMinutes").val()&&(d=a.find("#meetingMinutes").val(),f.append("meetingMinutes",d));"meetingMinutes"!==b&&((b=a.find("#meetingAttendees-"+b).val())&&f.append("meetingAttendees",b.toString()),f.append("scheduleDateJSON",JSON.stringify($("#myScheduler").scheduler("value"))),f.append("isRecurringMeeting",a.find("#isRecurringMeeting").is(":checked")),f.append("duration",a.find("#duration").val()),f.append("meetingAgenda",
a.find("#meetingAgenda").val()),f.append("meetingOwner",a.find("#meetingOwner").val()),b=a.find("#meetingDate").val()+" "+a.find("#meetingTime").val(),f.append("meetingDate",b),f.append("meetingTitle",a.find("#meetingTitle").val()));f.append("type",a.find("#type").val());f.append("appType",a.find("#appType").val());f.append("alertId",a.find("#alertId").val());f.append("attachmentSize",a.find("#attachments").prop("files").length);for(b=0;b<a.find("#attachments").prop("files").length;b++)f.append("attachments"+
b,a.find("#attachments").prop("files")[b]);return f},d=function(){$(".modal .modal-body .alert").remove()},e=function(a,b,d,f){var c=a.attendees;clearModal(b);for(var l=[],k=0;k<c.length;k++)l.push(c[k].id);c="";for(k=0;k<a.meetingAttachments.length;k++)c=c+"<a class='attachment-name m-t-15' target='_blank' href='"+("/signal/meeting/viewAttachments?attachmentId="+a.meetingAttachments[k].id+"&meetingId="+a.id)+"' download='"+a.meetingAttachments[k].name+"'> <i class='fa fa-file m-r-10' aria-hidden='true'> </i>"+
a.meetingAttachments[k].name+"</a></div>";b.find(".attachments .attachment-body").html(c);b.find(".id-element").attr("data-id",alertId);b.find(".meeting-id-element").attr("data-is-edit-series",d);d?(b.find(".meeting-id-element").attr("data-master-id",a.masterId),$("#cancelMeetingLink").hide(),$("#cancelMeetingSeriesLink").show(),b.find(".recurrence-checkbox-container").show(),$("#edit-meeting-title-container").text("Edit Series"),$(".isRecurringMeeting").attr("checked","checked"),$(".meetingDate").attr("disabled",
"disabled"),$(".meetingTime").attr("disabled","disabled"),$(".schedular-container").collapse("show")):(b.find(".meeting-id-element").attr("data-meeting-id",a.id),$("#cancelMeetingLink").show(),$("#cancelMeetingSeriesLink").hide(),b.find(".recurrence-checkbox-container").hide(),$("#edit-meeting-title-container").text("Edit Meeting"),$(".isRecurringMeeting").removeAttr("checked"),$(".meetingDate").removeAttr("disabled"),$(".meetingTime").removeAttr("disabled"),$(".schedular-container").collapse("hide"));
b.find("#meetingTitle").val(a.meetingTitle);b.find("#meetingOwner").val(a.ownerId);b.find("#meetingDate").val(moment(a.meetingDate,"DD-MMM-YYYY h:mm A").format("MM/DD/YYYY"));b.find("#meetingTime").val(moment(a.meetingDate,"DD-MMM-YYYY h:mm A").format("HH:mm"));b.find("#due-date-picker").datepicker();$("#meetingAttendees-"+f).find("option[isGuest='true']").remove();b.find("#meetingAgenda").val(a.meetingAgenda);a.guestAttendees&&$.each(a.guestAttendees,function(a,c){b.find("#meetingAttendees-"+f).append("<option value='"+
c+"' isGuest='true'>"+c+"</option>");l.push(c)});b.find("#meetingAttendees-"+f).val("");b.find("#meetingAttendees-"+f).find("option.guestAttendee").remove();b.find("#meetingAttendees-"+f).val(l);showTagWidget("#meetingAttendees-"+f);b.find("#duration").val(a.duration)};return{set_meeting_create_modal:function(){$("#createMeetingModal").on("shown.bs.modal",function(a){$(this).find(".clear-field").val("");$("#meetingAttendees-create").select2("val","");d();processScheduler("create")});$("#createMeetingModal").on("hidden.bs.modal",
function(a){unProcessScheduler("create");$(".meetingSuggestionContainer").collapse("hide")});$("#editMeetingModal").on("shown.bs.modal",function(a){d();processScheduler("edit",schedulerDataJson)});$("#editMeetingModal").on("hidden.bs.modal",function(a){unProcessScheduler("edit");$(".meetingSuggestionContainer").collapse("hide")});$(".meeting-create").click(function(a){a=$(a.target);var e=e;"undefined"!==typeof a.attr("alert-id")&&(e=a.attr("alert-id"));var h=$("#createMeetingModal");h.find(".id-element").attr("data-id",
e);"undefined"!=typeof e&&""!=e&&h.find(".alertId").val(e);d();$(".isRecurringMeeting").removeAttr("checked");$(".isRecurringMeeting").trigger("change");h.modal({});showTagWidget("#meetingAttendees-create");$("#create-meeting-btn,#create-iCalander").click(function(a){if(!a.handled){var c=$(this).data("icsFile");$(a.target).attr("data-id");a.handled=!0;$("#appType").val();a=$("#createMeetingModal #tempForm");$.ajax({type:"POST",url:"/signal/meeting/save?downloadICSFile="+c,data:b(a,"create"),async:!1,
processData:!1,contentType:!1,dataType:"json",cache:!1}).success(function(a){a.status?(downloadICSFile(c,a.data),h.find(".form-control").val(""),$("#meeting-table").DataTable().ajax.reload(),h.modal("hide"),signal.activities_utils.reload_activity_table(),signal.actions_utils.reload_action_table(),signal.meeting_utils.reload_meeting_table()):(d(),a=400==a.code?showErrorMessageInMeetingModal("Entered Email address is not valid"):showErrorMessageInMeetingModal("Please provide value for all the mandatory fields"),
$("#createMeetingModal .modal-body").prepend(a))}).error(function(a){d();a=showErrorMessageInMeetingModal(a.responseText);$("#createMeetingModal .modal-body").prepend(a)})}})})},init_meeting_table:function(g){var m="/signal/meeting/list?alertId="+alertId+"&appType="+appType;a=$(g).DataTable({language:{url:"../assets/i18n/dataTables_"+userLocale+".json"},fnDrawCallback:function(){var h=$("#appType").val();colEllipsis();webUiPopInit();$(".edit-meeting-series-link").click(function(a){var c,g=$(this).attr("data-master-id");
$.ajax({url:"/signal/meeting/getByMasterId?masterId="+g,async:!1,cache:!1}).success(function(a){schedulerDataJson=JSON.parse(a.schedularJson);c=$("#editMeetingModal");e(a,c,!0,"edit");c.modal({})});$(".update-meeting,#edit-iCalander").unbind().click(function(a){var f=$(this).data("icsFile");a="/signal/meeting/updateMeetingSeries?masterId="+g+"&appType="+h+"&downloadICSFile="+f;var e=$("#editMeetingModal #tempForm");$.ajax({url:a,type:"POST",data:b(e,"edit"),async:!1,processData:!1,contentType:!1,
dataType:"json",cache:!1}).success(function(a){a.status?(downloadICSFile(f,a.data),e.find(".form-control").val(""),e.find("#attachments").val(""),c.modal("hide"),signal.activities_utils.reload_activity_table(),signal.actions_utils.reload_action_table(),signal.meeting_utils.reload_meeting_table()):(d(),a=400==a.code?showErrorMessageInMeetingModal("Entered Email address is not valid"):showErrorMessageInMeetingModal("Please provide value for all the mandatory fields"),c.find(".modal-body").prepend(a))})})});
$(".add-meeting-minutes-link").click(function(d){var c=$("#meetingMinutesModal");d="/signal/meeting/getById?meetingId="+$(this).attr("data-id");var h=$(this).attr("data-id"),g=$("#meetingModalForm");$.ajax({url:d,async:!1,cache:!1,dataType:"json"}).success(function(a){var b=$(".meetingMinutes");e(a,c,!1,"meeting-minutes");e(a,c,!1,"edit");disableFormFields(g);b.removeAttr("disabled");b.val(a.meetingMinutes);c.modal({})});$(".update-meeting").unbind().click(function(d){$("#meetingModalForm #appType").val();
$("#meetingModalForm #alertId").val();$.ajax({url:"/signal/meeting/saveMeetingMinutes?meetingId="+h,type:"POST",data:b(c,"meetingMinutes"),async:!1,processData:!1,contentType:!1,dataType:"json",cache:!1}).success(function(b){c.find(".form-control").val("");c.find("#attachments").val("");c.modal("hide");signal.activities_utils.reload_activity_table();signal.actions_utils.reload_action_table();a.ajax.reload()})})});$(".edit-meeting-link").click(function(a){var c;a="/signal/meeting/getById?meetingId="+
$(this).attr("data-id");var h=$(this).attr("data-id");$.ajax({url:a,async:!1,cache:!1}).success(function(a){c=$("#editMeetingModal");e(a,c,!1,"edit");c.modal({})}).error(function(a){d();a=showErrorMessageInMeetingModal(a.responseText);$("#editMeetingModal .modal-body").prepend(a)});$(".update-meeting,#edit-iCalander").unbind().click(function(a){var f=$(this).data("icsFile");a="/signal/meeting/updateMeeting?meetingId="+h+"&downloadICSFile="+f;var e=$("#editMeetingModal #tempForm");$.ajax({url:a,type:"POST",
data:b(e,"edit"),async:!1,processData:!1,contentType:!1,dataType:"json",cache:!1}).success(function(a){a.status?(downloadICSFile(f,a.data),e.find(".form-control").val(""),e.find("#attachments").val(""),c.modal("hide"),signal.activities_utils.reload_activity_table(),signal.actions_utils.reload_action_table(),signal.meeting_utils.reload_meeting_table()):(d(),a=400==a.code?showErrorMessageInMeetingModal("Entered Email address is not valid"):showErrorMessageInMeetingModal("Please provide value for all the mandatory fields"),
c.find(".modal-body").prepend(a))})})})},fnInitComplete:function(a,b){$(".meeting-create").attr("data-id",alertId);signal.meeting_utils.set_meeting_create_modal();$("#due-date-picker").datepicker()},ajax:{url:m,cache:!1,dataSrc:""},searching:!0,dom:"Bfrtip",buttons:[{text:"New Meeting",className:"btn-primary meeting-create",action:function(a,b,c,d){}}],aaSorting:[[6,"desc"]],bLengthChange:!0,iDisplayLength:10,aLengthMenu:[[10,20,50,-1],[10,20,50,"All"]],aoColumns:[{mData:"meetingTitle",mRender:function(a,
b,c){a=moment(c.meetingDate,"DD-MMM-YYYY").format("DD-MMM-YYYY");b=escapeHTML(c.meetingTitle);c.isRecurrenceMeeting&&(b+="("+a+")");"CANCELLED"==c.meetingStatus&&(b+="("+c.meetingStatus+")");a='<div class="btn-group dropdown dataTableHideCellContent" align="left">                             <a class="dropdown-toggle" data-toggle="dropdown">                                 '+b+'<span class="sr-only">Toggle Dropdown</span>                             </a>                             <ul class="dropdown-menu" role="menu" style="min-width: 80px !important; font-size: 12px;">';
c.isMeetingEditable&&(a+='<li role="presentation"><a class="edit-meeting-link" role="menuitem"  data-id="'+c.id+'" href="#" >Edit Meeting</a></li>',c.isRecurrenceMeeting&&(a+='<li role="presentation"><a class="edit-meeting-series-link" role="menuitem"  data-master-id="'+c.masterId+'" href="#" >Edit Series</a></li>'));a+='<li role="presentation"><a class="add-meeting-minutes-link" role="menuitem" data-id="'+c.id+'" href="#" >Add Minutes</a></li>';return a+"</ul></div>"}},{mData:"meetingDate",mRender:function(a,
b,c){return moment(a,"DD-MMM-YYYY").format("dddd")+" "+moment(a,"DD-MMM-YYYY h:mm A").format("DD-MMM-YYYY h:mm A")}},{mData:"meetingMinutes",className:"col-min-150 cell-break col-max-200",mRender:function(a,b,c){return addEllipsis(c.meetingMinutes)}},{mData:"meetingOwner"},{mData:"meetingAgenda",className:"col-min-150 col-max-300 cell-break ",mRender:function(a,b,c){return addEllipsis(c.meetingAgenda)}},{mData:"modifiedBy"},{mData:"lastModified"},{mData:"",mRender:function(a,b,c){return 3==c.actionStatus?
'<img src="/signal/assets/icons/high_priority.png"/>':2==c.actionStatus?'<img src="/signal/assets/icons/medium_priority.png"/>':1==c.actionStatus?'<img src="/signal/assets/icons/low_priority.png"/>':""}}],scrollX:!0,scrollY:"270px",columnDefs:[{targets:"_all",render:$.fn.dataTable.render.text()}]});a.button().disable();return meetingDataTable=a},reload_meeting_table:function(){meetingDataTable.ajax.reload()}}}();
function showErrorMessageInMeetingModal(a){var b="<div class='alert alert-danger'>";return(a?b+a:b+"Please fill  the required Fields")+"</div>"}$(document).on("click",".closeMeetingModal",function(a){bootbox.confirm({message:"There are unsaved changes for this meeting. Do you still want to close it?",buttons:{confirm:{label:"Yes",className:"btn-primary"},cancel:{label:"No",className:"btn-default"}},callback:function(a){bootbox.hideAll();a&&$("#createMeetingModal").modal("hide")}})});
function clearModal(a){a.find("input[type=text]").val("");a.find("textarea").val("")}function disableFormFields(a){a.find("select").attr("disabled",!0);a.find("textarea").attr("disabled",!0);a.find(".searchMeetingTimes").addClass("disabled")}
$(document).on("change",".isRecurringMeeting",function(){$(this).is(":checked")?($(".schedular-container").collapse("show"),$(".meetingDate").attr("disabled","disabled"),$(".meetingTime").attr("disabled","disabled")):($(".schedular-container").collapse("hide"),$(".meetingDate").removeAttr("disabled"),$(".meetingTime").removeAttr("disabled"))});
function intializeSchedular(){$(".myScheduler").scheduler("value",{startDateTime:(new Date).toISOString(),timeZone:{name:"Asia/Kolkata"},recurrencePattern:"BYDAY=MO"})}$(document).on("click",".searchMeetingTimes",function(){$(this).find(".time-slot-container").html("");$(".meetingSuggestionContainer").collapse("toggle")});
$(document).on("click",".findMeetingTimes",function(){$(this).find(".time-slot-container").html("");var a=$(this).data("text"),b;b="create"==a?$("#createMeetingModal"):$("#editMeetingModal");var d={fmtStartDate:$("#fmtStartDate-"+a).val(),fmtEndDate:$("#fmtEndDate-"+a).val(),duration:$("#duration").val()};if(a=b.find("#meetingAttendees-"+a).val())d.meetingAttendees=a.toString();var e=b.find(".modal-body").find("#msg-container");$.ajax({type:"POST",url:$("#findMeetingTimesUrl").val(),data:$.param(d),
dataType:"json",success:function(a){a.status?(e.hide(),showTimeSuggestions(a.data),$(".meetingSuggestionContainer").collapse("show")):(a=showErrorMessageInMeetingModal(a.message),e.html(a),e.show(),$(".time-slot-container").html(""))}})});$(document).on("click",".selectTimeSlot",function(){$(".meetingDate").val($(this).data("startDate"));$(".meetingTime").val($(this).data("startTime"));$(".meetingSuggestionContainer").collapse("hide")});
function showTimeSuggestions(a){var b;a&&(b=a.meetingTimeSuggestions);var d="",e,g;b?$.each(b,function(a,b){e=moment(b.timeSlot.startDateTime).format("MM/DD/YYYY");g=moment(b.timeSlot.startDateTime).format("HH:mm:ss");d+='<div class="panel panel-warning meeting-slot-container"><div class="panel-body"><div class="meeting-suggestion row"><div class="col-md-4">'+moment(b.timeSlot.startDateTime).format("DD-MMM-YYYY")+" "+g+'</div><div class="col-md-4">'+moment(b.timeSlot.endDateTime).format("DD-MMM-YYYY")+
" "+moment(b.timeSlot.endDateTime).format("HH:mm:ss")+'</div><div class="col-md-4"><a class="btn btn-primary selectTimeSlot" data-start-date="'+e+'" data-start-time="'+g+'">Select</a></div></div></div></div>'}):d+='<div class="panel panel-warning meeting-slot-container"><div class="panel-body">No Time Slot found for given date.</div></div>';$(".time-slot-container").html(d)}
$(document).on("click",".cancelMeetingLink",function(a){a.preventDefault();a=$(this).data("isEditSeries")?$(this).attr("href")+"?masterId="+$(this).data("master-id"):$(this).attr("href")+"&id="+$(this).data("meeting-id");$.ajax({type:"POST",url:a,data:{},dataType:"json",success:function(a){$("#editMeetingModal").modal("hide");signal.activities_utils.reload_activity_table();signal.actions_utils.reload_action_table();meetingDataTable.ajax.reload()}})});
function processScheduler(a,b){var d=$("#schedularContainer"),e=d.html();$(".schedular-container-"+a).html(e);d.html("");initializeScheduler(b)}function unProcessScheduler(a){a=$(".schedular-container-"+a);var b=a.html();$("#schedularContainer").html(b);a.html("")}
function initializeScheduler(a){$("#myScheduler").scheduler();if("undefined"===typeof a||null===a)setToday();else for($("#myScheduler").scheduler("value",{startDateTime:a.startDateTime,timeZone:{offset:a.timeZone.offset},recurrencePattern:a.recurrencePattern}),a=$("#myScheduler").scheduler("value"),$("#configSelectedTimeZone").val(a.timeZone.name),a=0;24>a;a++)for(var b=0,d=0;2>d;d++)$("#myScheduler #timeSelect ul").append('<li><a href="#">'+calculateAllIntervals(a,b)+"</a></li>"),b=30}
$("#myScheduler").on("changed.fu.scheduler",function(a,b){a=$("#myScheduler").scheduler("value");$("#scheduleDateJSON").val(JSON.stringify(a));$("#configSelectedTimeZone").val(a.timeZone.name)});
$("#myDatePicker").click(function(){var a=new Date,b=$("#MyStartDate").val();$("#schedulerFrom").val();if(a<new Date(b))for($("#myScheduler #timeSelect ul").empty(),a=0;24>a;a++){for(var d=b=0;2>d;d++)$("#myScheduler #timeSelect ul").append('<li><a href="#">'+calculateAllIntervals(a,b)+"</a></li>"),b=30;$("#myStartTime").val("12:00 AM")}else setToday();a=$("#myScheduler").scheduler("value");$("#scheduleDateJSON").val(JSON.stringify(a));$("#configSelectedTimeZone").val(a.timeZone.name)});
if(document.getElementById("enable")){var enable=$("#enable").val();enable&&$("#schedule *").prop("disabled",!0)}function calculateNxtInterval(a,b){var d=a.getHours()+0;a=a.getMinutes()+b;60<=a&&(d+=Math.floor(a/60),a%=60);b=12<=d?"PM":"AM";d=(d%=12)?d:12;return(9<d?d:"0"+d)+":"+(9<a?a:"0"+a)+" "+b}function calculateAllIntervals(a,b){var d=12<=a?"PM":"AM";a=(a%=12)?a:12;return(9<a?a:"0"+a)+":"+(9<b?b:"0"+b)+" "+d}
function calculateNumberOfIntervals(a,b,d){a=2*(12-a);"AM"==d&&(a+=48);return 30>b?a:a-1}
function setToday(){var a=$("#schedulerTime").val();"undefined"!=typeof a&&parseInt(a);var a=new Date,b=calculateNxtInterval(a,0),d=b.split(":")[0],e=b.split(":")[1].split(" ")[0],g=30>e?30-e:60-e;$("#time").text(b);b=calculateNumberOfIntervals(d,e,b.split(":")[1].split(" ")[1]);for(d=0;d<b-1;d++)$("#myScheduler #timeSelect ul").append('<li><a href="#">'+calculateNxtInterval(a,g)+"</a></li>"),g+=30;b=$("#timezoneFromServer").val();g=null;"undefined"!=typeof b&&null!=b&&(g=b.split(","));g&&(b=g[0].split(":")[1].trim(),
g=g[1].substring(8).trim(),$("#myScheduler").scheduler("value",{startDateTime:moment(a).format("YYYY-MM-DDTHH:mm:ss.sTZD"),timeZone:{name:b,offset:g}}))}function showTagWidget(a){$(a).select2({tags:!0,placeholder:"Select Attendees",allowClear:!0,width:"100%",createTag:function(a){a=$.trim(a.term);return""!=a?{id:a,text:a}:null}})}function downloadICSFile(a,b){a&&window.open("data:text/calendar;charset=utf8,"+escape(b))};