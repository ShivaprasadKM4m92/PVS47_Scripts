var signal = signal || {};

// a convenience function for parsing string namespaces and
// automatically generating nested namespaces
function extend( ns, ns_string ) {
    var parts = ns_string.split('.'),
        parent = ns,
        pl, i;
    if (parts[0] == "signal") {
        parts = parts.slice(1);
    }
    pl = parts.length;
    for (i = 0; i < pl; i++) {
        //create a property if it doesnt exist
        if (typeof parent[parts[i]] == 'undefined') {
            parent[parts[i]] = {};
        }
        parent = parent[parts[i]];
    }
    return parent;
}

//Prototype methods
Date.prototype.addDays = function(days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
};

Array.prototype.remove = function (value) {
    return this.filter(function(f){f != value});
};

SCA_WORKFLOW_STATUS_ENUM = { NEW: 'New',
    ASSOCIATE_REVIEWED: 'AssociateReviewed',
    PHYSICIAN_REVIEWED: 'PhysicianReviewed',
    REQUIRED_EVALUATION: 'RequiredEvaluation',
    CONTINUED_MONITORING: 'ContinuedMonitoring'
};

SCA_DISPOSITION_ENUM = {
    VALIDATED_SIGNAL : 'ValidatedSignal',
    VALIDATED_NON_CONFIRMED_SIGNAL : 'ValidatedNonConfirmedSignal',
    VALIDATED_UNDER_INVESTIGATION : 'ValidatedUnderInvestigation',
    COMMUNICATED_SIGNAL : 'CommunicatedSignal',
    NON_VALID: 'NonValid'
};

SCA_PRIORITY_ENUM = {
    HIGH: "High",
    MEDIUM: "Medium",
    LOW: "LOW"
};

DATE_FMT_TZ = "YYYY-MM-DD";

signal.utils = (function() {

    var stacked = function(topValue, bottomValue) {
        var topComp = "";
        var bottomComp = "";

        if(_.isFunction(topValue)) {
            topComp = topValue()
        } else {
            topComp = '<div class="stacked-cell-center-top">' + topValue + '</div>'
        }

        if (_.isFunction(bottomValue)) {
            bottomComp = bottomValue()
        } else {
            bottomComp = '<div class="stacked-cell-center-bottom">' + bottomValue + '</div>'
        }

        return topComp + bottomComp
    };

    // And this is the definition of the custom function â€‹
    var render = function(tmpl_name, tmpl_data) {

        if ( !render.tmpl_cache ) {



            render.tmpl_cache = {};
        }
        if (!render.tmpl_cache[tmpl_name]) {
            var tmpl_dir = '/signal/assets/app/pvs/hbs-templates';
            var tmpl_url = tmpl_dir + '/' + tmpl_name + '.hbs';

            var tmpl_string = "";
            $.ajax({
                url: tmpl_url,
                method: 'GET',
                async: false,
                success: function(data) {
                    tmpl_string = data
                }
            });

            render.tmpl_cache[tmpl_name] = Handlebars.compile(tmpl_string);
        }

        return render.tmpl_cache[tmpl_name](tmpl_data)
    };

    var hbs_partial = function(tmpl_name) {
        if (!hbs_partial.tmpl_cache) {
            hbs_partial.tmpl_cache = {}
        }

        if (!hbs_partial.tmpl_cache[tmpl_name]) {
             var tmpl_dir = '/signal/assets/app/pvs/hbs-templates';
            var tmpl_url = tmpl_dir + '/' + tmpl_name + '.hbs';

            var tmpl_string = "";
            $.ajax({
                url: tmpl_url,
                method: 'GET',
                async: false,
                success: function(data) {
                    tmpl_string = data
                }
            });

            hbs_partial.tmpl_cache[tmpl_name] = tmpl_string
        }

        return hbs_partial.tmpl_cache[tmpl_name]
    };

    var composeUrl = function(controller, action, params) {
        var url = "/signal/" + controller + "/" + action + (_.isNull(params) ? '' : '?' + composeParams(params));

        return url
    };

    //TODO : Need to change this to handlebar form, Will be done later
    var postUrl = function (path, params, newWindow) {

        const form = document.createElement('form');
        form.method = "post";
        form.action = path;
        form.enctype = "application/x-www-form-urlencoded";
        if (newWindow) form.target = "_blank";

        var token = $("meta[name='_csrf']").attr("content");
        var parameter = $("meta[name='_csrf_parameter']").attr("content");
        params[parameter] = token;
        for (let key in params) {
            if (params.hasOwnProperty(key)) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = key;
                hiddenField.value = params[key];
                form.appendChild(hiddenField);
            }
        }
        document.body.appendChild(form);
        form.submit();
    }

    var composeParams = function(o) {
        return _.map(_.pairs(o), function(p){return p.join('=')} ).join('&')
    };

    var capitalIt = function(s) {
        return s && s[0].toUpperCase() + s.slice(1);
    };

    var breakIt = function(s) {
        return s ? s.split(/(?=[A-Z])/).join(' ') : s
    };

    var enable_load_button = function(ele, enabled) {
        return function(evt) {
            var targetEle = ele.find('.glyphicon');
            if (enabled) {
                $(targetEle).addClass('refresh-animate');
            } else {
                $(targetEle).removeClass('refresh-animate');
            }
        }
    };
    var setInLocalStorage = function(prop, data) {
        localStorage.setItem(prop, data);
    };

    var getFromLocalStorage = function(prop) {
        return localStorage.getItem(prop);
    };

    var setJSONInLocalStorage = function(prop, data) {
        localStorage.setItem(prop, JSON.stringify(data));
    };

    var getJSONFromLocalStorage = function (prop) {
        return JSON.parse(localStorage.getItem(prop));
    };

    var localStorageUtil = {
        setProp : setInLocalStorage,
        getProp : getFromLocalStorage,
        setJSON : setJSONInLocalStorage,
        getJSON : getJSONFromLocalStorage
    };

    var getQueryString = function() {
        var key = false, res = {}, itm = null;
        // get the query string without the ?
        var qs = location.search.substring(1);
        // check for the key as an argument
        if (arguments.length > 0 && arguments[0].length > 1)
            key = arguments[0];
        // make a regex pattern to grab key/value
        var pattern = /([^&=]+)=([^&]*)/g;
        // loop the items in the query string, either
        // find a match to the argument, or build an object
        // with key/value pairs
        while (itm = pattern.exec(qs)) {
            if (key !== false && decodeURIComponent(itm[1]) === key)
                return decodeURIComponent(itm[2]);
            else if (key === false)
                res[decodeURIComponent(itm[1])] = decodeURIComponent(itm[2]);
        }

        return key === false ? res : null;
    };

    return {
        render : render,
        stacked: stacked,
        composeUrl: composeUrl,
        postUrl: postUrl,
        composeParams: composeParams,
        capitalIt: capitalIt,
        breakIt: breakIt,
        hbs_partial: hbs_partial,
        enable_load_button: enable_load_button,
        localStorageUtil: localStorageUtil,
        getQueryString: getQueryString
    }
})();



Handlebars.registerHelper('i18n',
    function(str){
        return ( (typeof i18n) !== 'undefined' ? str : str)
    }
);

Handlebars.registerHelper('select', function(name, selectedValue, options, disp_field, value_field) {
    var out = "<select class='form-control selectBox' id=\'" + name + "\' name=" + name + ">\n";
    _.each(options, function(v) {
        out += "<option value='" + v[value_field] + "'" +
            (v[value_field] == selectedValue[value_field] ? " selected " : "") + " >" +
            escapeHTML(v[disp_field]) + "</option>\n"
    });
    out += "</select>";

    return new Handlebars.SafeString(out)
});

Handlebars.registerPartial('date_picker_template', signal.utils.hbs_partial('date_picker_template'));

//Handlebar helper to imitate the if conditions
Handlebars.registerHelper('if_eq', function(a, b, opts) {
    if (a == b) {
        return opts.fn(this);
    }
});

//Handlebar helper to imitate the if..else conditions
Handlebars.registerHelper('if_else_eq', function(a, b, opts) {
    if (a == b) {
        return opts.fn(this);
    } else {
        return opts.inverse(this);
    }
});

Handlebars.registerHelper('if_tag_exist', function(key, value,tags, opts) {
    if(value.tagText == tags[key-1].tagText && value.subTagText!=null && value.subTagText != tags[key-1].subTagText){
        return opts.fn(this);
    } else{
        return opts.inverse(this);
    }
});

Handlebars.registerHelper('if_else_neq', function(a, b, opts) {
    if (a != b) {
        return opts.fn(this);
    } else {
        return opts.inverse(this);
    }
});

//= require app/pvs/common/rx_handlebar_ext.js

var signal = signal || {};

signal.alerts_utils = (function() {
    var priorities;
    var workflowStates;

    var get_priorities = function() {
        $.ajax({
            url: "/signal/workflow/priorities",
            async: false,
            success: function(result) {
                priorities = result
            }
        });

        return priorities
    };

    var get_workflowStates = function(initData) {
        $.ajax({
            url: "/signal/workflow/workflowState",
            async: false,
            data: initData,
            success: function(result) {
                workflowStates = result
            }
        });

        return workflowStates
    };

    var priorities_selections = function(data, type, row) {
        var new_select = '<div><select class="form-control add-cursor" ' +
            'style="height: 30px;" onchange="updatePriority(this.value,' + row.id + ')">';
        var priority = row.priority;

        var the_select = _.reduce(priorities, function(m, p){
            if (p.value == priority)
                return m + '<option value="' + p.value + '" selected> ' + p.displayName + '</option>';
            else
                return m + '<option value="' + p.value + '">' + p.displayName + '</option>'
        }, new_select);
        the_select = the_select + '</select></div>';
        return the_select;
    };

    var workflow_selections = function(data, type, row) {
        var new_select = '<div><select class="form-control add-cursor" style="height: 30px;" onchange="updateStatus(this.value,' + row.id + ')">';
        var workflowState = row.workflowState;

        var the_select = _.reduce(workflowStates, function(m, ws){
            if (ws.value == workflowState)
                return m + '<option value="' + ws.value + '" selected> ' + ws.displayName + '</option>';
            else
                return m + '<option value="' + ws.value + '">' + ws.displayName + '</option>'
        }, new_select);
        the_select = the_select + '</select></div>';
        return the_select;
    };

    var compose_edit_state_link = function(value, rowId, filedName) {
        return "<span>" + value + "</span>" + "<a href='#' class='edit-state' >" +
            "<i class='fa fa-share-alt pull-right' data-field='"  + filedName +
            "' data-id='" + rowId + "'/></a>"
    };

    var state_changed = function(extra_values) {
        $("#valueSelect").change(function(evt) {
            var available_extra_values = extra_values[$(valueSelect).val()]
        })
    };

    //TODO this is a temp solution for the JSON format. It should come from server side
    //Function that converts the json innerhtml to the csv values.
    //It converts the properties which are not id.
    var show_json_as_csv = function (elementClass) {
        $("." + elementClass).each(function () {
           try {
              if (isNaN($(this).html())) {
                  var modifiedVal = "";
                  var jsonVal = JSON.parse($(this).html());
                  for (var obj in jsonVal) {
                     if (jsonVal.hasOwnProperty(obj)) {
                        for (var prop in jsonVal[obj]) {
                           if (jsonVal[obj].hasOwnProperty(prop)) {
                              if (prop != 'id') {
                                 modifiedVal = modifiedVal + jsonVal[obj][prop] + ","
                              }
                           }
                        }
                     }
                  }
                  $(this).html(modifiedVal.slice(0, -1))
              }
           } catch (err) {
              //Do nothing
              //console.log(err)
           }
           $(this).html()
        })
    };

    var init_matched_alerts_table = function(tableEle, url) {
        var table = tableEle.DataTable({
            "language": {
                "url": "/signal/assets/i18n/dataTables_" + userLocale + ".json"
            },

            ajax: {
                url: url,
                dataSrc: '',
                error: function(xhr,status,error){}
            },

            aoColumns:[
                {
                    mData: 'name'
                },
                {
                    mData: 'productSelection'
                },
                {
                    mData: 'topic'
                },
                {
                    mData: 'detectedDate'
                },
                {
                    mData: 'disposition'
                }
            ],
            dom: ''
        });

        return table
    };

    var getSignalNameList = function(signalsAndTopics) {
        var signalAndTopics = '';
        $.each(signalsAndTopics, function(i, obj){
            var url = signalDetailUrl + '?id=' + obj['signalId'];
            signalAndTopics = signalAndTopics + '<span class="click"><a href="' + url + '">' + obj['name'] + '</a></span>&nbsp;'
            signalAndTopics = signalAndTopics + ","
        });
        if(signalAndTopics.length > 1)
            return '<div>' + signalAndTopics.substring(0, signalAndTopics.length - 1) + '</div>';
        else
            return '-';
    };

    // For shared with modal
    var initializeShareWithSelect2 = function(){
        $('#shareWith').select2().on("change", function (e) {
            $('#shareWith').parent().removeClass('has-error');
        });
    };

    var initializeShareWithValues = function(){
        $('#sharedWithModal').on('show.bs.modal', function(e) {
            var executedConfigId = e.relatedTarget.id;
            $('#executedConfigId').val(executedConfigId);
            $('#sharedWith').parent().removeClass('has-error');

            $.ajax({
                cache: false,
                type: 'GET',
                url: getSharedWith + '?id=' + executedConfigId,
                success: function(result) {
                    var users = '';
                    $.each(result.users, function() {
                        users += this.name + '<br />'
                    });
                    $('#sharedWithUserList').html(users);
                    var groups = '';
                    $.each(result.groups, function() {
                        groups +=  this.name + ' <br />'
                    });
                    $('#sharedWithGroupList').html(groups);

                    $.each(result.all, function(i, data){
                        var option = new Option(data.name, data.id, true, true);
                        $('#sharedWith').append(option).trigger('change');
                    });
                }
            });

            sharedWithModalShow = true;

        }).on('hidden.bs.modal', function(e) {
            sharedWithModalShow = false;
            $('#sharedWith').val(null).trigger('change');
            $('#sharedWith').find('option').remove();
        });
    };

    var getTagsElement = function(tags) {
        var tagsElement = '<div class="tag-container block-ellipsis"><div class="tag-length">';
        var globalTagsArray = [];
        var alertTagsrray = [];
        var privateTagsArray = [];
        $.each(tags, function (key, value) {
            if (value.privateUser == '(P)') {
                privateTagsArray.push(value)
            } else if (value.tagType == '(A)') {
                alertTagsrray.push(value)
            } else {
                globalTagsArray.push(value);
            }
            tagsElement += signal.utils.render('tags_details', {
                key: key,
                value: value,
                tags:tags,
            });
        });
        var viewAllElements = fetchViewAllTags(globalTagsArray , alertTagsrray , privateTagsArray);

        tagsElement += '<a tabindex="0" title="Add/Edit Categories" class="editAlertTags btn-edit-tag mid"><i class="mdi mdi-pencil-box font-20 blue-1"> </i></a>';
        tagsElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="'+viewAllElements+'"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
        tagsElement += '</div></div>';
        return tagsElement
    };

    var fetchViewAllTags = function(globalTagsArray , alertTagsArray , privateTagsArray) {
        var returnElement = "";
        if (globalTagsArray.length > 0) {
            returnElement = "<p class='pbr' style='margin-top:7px'><b>Global Category</b><hr class='tagehr'>";
            returnElement += signal.utils.render('tags_details_view_all', {tags: globalTagsArray}) + "</p>"  ;
        }
        if (alertTagsArray.length > 0) {
            returnElement += "<p class='pbr' style='margin-top:7px'><b>Alert Specific Category</b><hr class='tagehr'>";
            returnElement += signal.utils.render('tags_details_view_all', {
                tags: alertTagsArray,
            })  + "</p>" ;
        }
        if (privateTagsArray.length > 0) {
            returnElement += "<p class='pbr' style='margin-top:7px'><b>Private Category</b><hr class='tagehr'>";
            returnElement += signal.utils.render('tags_details_view_all', {tags: privateTagsArray})  + "</p>" ;
        }
        return returnElement
    };
    return {
        get_priorities: get_priorities,
        priorities_selections: priorities_selections,
        get_workflowStates: get_workflowStates,
        workflow_selections: workflow_selections,
        compose_edit_state_link: compose_edit_state_link,
        state_change: state_changed,
        show_json_as_csv: show_json_as_csv,
        init_matched_alerts_table: init_matched_alerts_table,
        getSignalNameList: getSignalNameList,
        initializeShareWithSelect2 : initializeShareWithSelect2,
        initializeShareWithValues:initializeShareWithValues,
        get_tags_element : getTagsElement
    }
})();

var signal = signal || {};

signal.list_utils = (function () {
    var flag_it = function (flag, id) {
        var theHtml = '<i class="fa fa-flag-o text-muted rx-list-flag" data-id="' + id + '"></i>'
        if (flag) {
            theHtml = '<i class="fa fa-flag text-primary rx-list-flag" data-id="' + id + '"></i>'
        }
        return theHtml
    };

    var flag_handler = function (controller, action) {
        $(document).on('click', '.rx-list-flag', function (e) {
            var ele = e.target;
            var id = $(ele).attr('data-id');

            $.ajax({
                url: "/signal/" + controller + "/" + action + "?id=" + id,
                success: function (result) {
                    if (result.flagged) {
                        $(ele).removeClass('fa-flag-o').removeClass('text-muted');
                        $(ele).addClass('fa-flag').addClass('text-primary');
                    } else {
                        $(ele).addClass('fa-flag-o').addClass('text-muted');
                        $(ele).removeClass('fa-flag').removeClass('text-primary')
                    }
                }
            })
        })
    };

    var priority_link = function (priority, id) {
        var icon_url = compose_priority_icon(priority);
        return '<a href="#" class="change-priority"><img data-field="priority" data-info="row" data-id="' +
            id + '" data-value="' + priority + '" src="' + icon_url + '"/></a>'
    };

    var compose_priority_icon = function (priority) {
        var icon_url = "/signal/assets/icons/default_priority.png";

        if (_.contains(['high', 'low', 'medium'], priority.toLowerCase())) {
            icon_url = "/signal/assets/icons/" + priority.toLowerCase() + "_priority.png";
        }
        return icon_url;
    };

    var change_priority = function (priorityEle, priority) {
        var icon_url = compose_priority_icon(priority);
        $(priorityEle).attr("src", icon_url);
        $(priorityEle).attr("data-value", priority);
    };

    var change_priorityTest = function (priorityEle, priority) {
        $(priorityEle).attr("data-value", priority);
    };

    change_priorityTest

    var find_field = function (table_row_ele, attr_name) {
        return $(table_row_ele).find("[data-attribute-name='" + attr_name + "']")
    };

    var set_value = function (table_row_ele, attr_name, id, data_fun, app_name) {
        var ele = find_field(table_row_ele, attr_name);
        ele.html(data_fun(id, app_name));
    };

    var get_due_in = function (id, app_name) {
        var dueIn = 0;
        $.ajax({
            url: "/signal/alert/dueIn?alertId=" + id + "&appName=" + app_name,
            async: false,
            success: function (data) {
                dueIn = data.result;
            }
        });
        return dueIn
    };

    var due_in_comp = function (value) {
        if (value <= 0) {
            return "<div data-attribute-name='dueIn' style = 'color:red'>" + value + "</div>";
        } else {
            return "<div data-attribute-name='dueIn'>" + value + "</div>";
        }
    };

    var assigned_to_comp = function (id, assignedTo) {
        var html = '<div class="assignedToContainer"><select class="assignedToSelect form-control select2"></select><i class="mdi mdi-spin mdi-loading assignToProcessing" style="display: none"></i></div>';
        return html
    };

    var truncateTextAndShowTooltip = function (cutoff, wordbreak, escapeHtml) {
        var esc = function (t) {
            return t
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        };

        return function (d, type, row) {
            // Order, search and type get the original data
            if (type !== 'display') {
                return d;
            }

            if (typeof d !== 'number' && typeof d !== 'string') {
                return d;
            }

            d = d.toString(); // cast numbers

            if (d.length <= cutoff) {
                return esc(d);
            }

            var shortened = d.substr(0, cutoff - 1);

            // Find the last white space character in the string
            if (wordbreak) {
                shortened = shortened.replace(/\s([^\s]*)$/, '');
            }

            // Protect against uncontrolled HTML input
            if (escapeHtml) {
                shortened = esc(shortened);
            }

            return '<span class="ellipsis" title="' + esc(d) + '">' + shortened + '&#8230;</span>';
        };
    };

    var add_filters = function (table, filters, filter_toggle_bt_container) {

        var yadcf_filters = _.filter(filters, function (f) {
            if (f[1] != 'customized') {
                return true;
            } else {
                return false;
            }
        });

        var cust_filters = _.difference(filters, yadcf_filters);

        yadcf.init(table, _.map(yadcf_filters, function (item) {
            if (item[2] == true)
                return {column_number: item[0], filter_type: item[1], filter_reset_button_text: 'x'};
            else
                return {column_number: item[0], filter_type: item[1], filter_reset_button_text: false};
        }));

        if (filter_toggle_bt_container) {
            add_filter_toggle_button('idxxxxxx', filter_toggle_bt_container);
        }

        if (cust_filters) {
            _.each(cust_filters, function (f) {
                $(table.column(f[0]).header()).append(create_stacked_filter(f[0]));
            });
        }
    };

    var create_stacked_filter = function (idx) {
        return $("<input type='text' data-index='" + idx + "' class='column-filter' placeholder='Type to filter'>" +
            "<input type='text' data-index='" + idx + "' class='column-filter' placeholder='Type to filter'>");
    };

    var add_filter_toggle_button = function (table_id, container) {
        $('.yadcf-filter-wrapper, .column-filter').hide();
        $('.column-filter').click(function (evt) {
            evt.preventDefault();
            return false;
        });
        $('.column-filter').on('keyup', function (evt) {
            // Perform search
            var index = $(this).data('index');
            $(table_id).DataTable().column(index).search($(this).val()).draw();
        });
        var filterToggle = "<i class='table-filter-toggle glyphicon glyphicon-filter' data-table='" + table_id +
            "' onclick='signal.list_utils.handle_filter_toggle' data-show-filter='true'></i>";
        var toggle_button = $.parseHTML(filterToggle);
        if (!(_.isUndefined(container) && _.isNull(container))) {
            container.append(toggle_button);
        }

        $(document).on('filter-toggle-init', function (evt) {
            $('.table-filter-toggle').click(function (evt) {
                var hide_show_fitler = function (tableId, hideOrShow) {
                    if (hideOrShow === false) {
                        $(tableId + '_wrapper .yadcf-filter-wrapper,.column-filter').hide();
                    } else {
                        $(tableId + '_wrapper .yadcf-filter-wrapper,.column-filter').show();
                    }
                };

                var targetFilterToggle = $(evt.target);
                var tableId = targetFilterToggle.data('table');
                var showFilter = targetFilterToggle.data('show-filter');
                if (showFilter === 'true') {
                    targetFilterToggle.data('showFilter', 'false');
                    hide_show_fitler(tableId, false);
                } else {
                    targetFilterToggle.data('showFilter', 'true');
                    hide_show_fitler(tableId, true);
                }
            });
        });

        $(document).trigger('filter-toggle-init');
        return $(toggle_button);
    };

    var handle_filter_toggle = function (evt) {
        $(this).attr('target-table');
    };

    return {
        flag_it: flag_it,
        flag_handler: flag_handler,
        priority_link: priority_link,
        change_priority: change_priority,
        find_field: find_field,
        set_value: set_value,
        get_due_in: get_due_in,
        due_in_comp: due_in_comp,
        assigned_to_comp: assigned_to_comp,
        truncateTextAndShowTooltip: truncateTextAndShowTooltip,
        add_filters: add_filters,
        handle_filter_toggle: handle_filter_toggle,
        add_filter_toggle_button: add_filter_toggle_button
    }
})();
var signal = signal || {};

signal.actions_utils = (function() {
    var action_list_table;
    var current_create_bt;
    var adhoc_validated_table;

    var set_action_create_modal = function () {
        $('#createActionModal').on('hidden.bs.modal', function (e) {
            $(this)
                .find('#config').val('').end()
                .find('#type').val('').end()
                .find('#meetingElement').val('').end()
                .find('.assignedToValue').val('').trigger('change').end()
                .find('.assignedToValue').empty().end()
                .find("input[type=text],textarea").val('')
                .end();

            $('#createActionModal .select2-selection__rendered').hover(function () {
                $(this).removeAttr('title');
            });

        });

        $('#action-edit-modal').on('hidden.bs.modal', function (e) {
            clear_edit_errors();
            $(this)
                .find("input[type=text],textarea,select")
                .val('')
                .end()
        });

        $('#editActionModal').on('hidden.bs.modal', function (e) {
            clear_edit_signal();
            $(this)
                .find("input[type=text],textarea,select")
                .val('')
                .end()
        });

        $(document).on('click', '.action-create', function (evt) {
            var srcEle = $(evt.target);
            current_create_bt = srcEle;
            var alertId = alertId;
            if (typeof (srcEle.attr('alert-id')) !== 'undefined') {
                alertId = srcEle.attr('alert-id')
            }
            var createActionModal = $('#createActionModal');
            var createActionButton = $("#create-action-btn");
            createActionModal.find('.id-element').attr('data-id', alertId);

            //Set the alertId in the hidden field of the modal.
            if (typeof alertId != "undefined" && alertId != '') {
                createActionModal.find(".alertId").val(alertId);
            }

            createActionModal.find('#due-date-picker').datepicker();
            createActionButton.attr("disabled", false);
            clear_errors();
            $('.action-type-list').removeClass('hidden');
            $('.meeting-list').addClass('hidden');
            createActionModal.modal({});

            //Event bind when the save/create button is click
            // ked in the action event modal.
            createActionButton.unbind('click').click(function (event) {
                createActionButton.attr("disabled", true);
                var alertId = $(event.target).attr('data-id');
                var actionModalId = $("#createActionModal #tempForm");
                $.ajax({
                    type: "POST",
                    url: '/signal/action/save',
                    data: getActionDetails(actionModalId),
                    async: false,
                    cache: false
                }).success(function (response) {
                    if (response.status == false) {
                        clear_errors();
                        var errorMsg = "<div class='alert alert-danger'>";
                        for (var index = 0; index < response.data.length; index++) {
                            var errorMessageObj = response.data[index];
                            errorMsg += errorMessageObj;
                            errorMsg += '</br>';
                        }
                        errorMsg += "</div>";
                        $('#createActionModal .modal-body').prepend(errorMsg);
                        createActionButton.attr("disabled", false);
                    } else {
                        createActionModal.modal('hide');
                        current_create_bt.parentsUntil("td").find('.default-value').html(response.actionCount);

                        if (typeof applicationLabel != 'undefined' && applicationLabel === "Case Detail") {
                            $('#action-table').DataTable().ajax.reload();
                        } else {
                            if (typeof alertId != "undefined" && alertId != '') {
                                if (typeof detail_table != "undefined") {
                                    detail_table.ajax.reload();
                                }
                            } else {
                                $('#action-table').DataTable().ajax.reload();
                                $('#meeting-table').DataTable().ajax.reload();
                                $('#signalActivityTable').DataTable().ajax.reload();
                            }
                        }

                        //Refresh the activity table
                        if (typeof applicationLabel != 'undefined' && applicationLabel !== APPLICATION_LABEL.CASE_DETAIL && applicationLabel !== APPLICATION_LABEL.EVENT_DETAIL) {
                            signal.activities_utils.reload_activity_table();
                            if (applicationLabel == APPLICATION_LABEL.SIGNAL_MANAGEMENT) {
                                signal.meeting_utils.reload_meeting_table();
                            }
                        }
                    }
                }).error(function (data) {
                    clear_errors();
                    var errorMsg = "<div class='alert alert-danger'>";
                    errorMsg += "Error occured while saving Action.";
                    errorMsg += "</div>";
                    $('#createActionModal .modal-body').prepend(errorMsg);
                    createActionButton.attr("disabled", false);
                })
            })
        })
    };

    var getActionDetails = function(modalId) {
        return {
            "config": modalId.find("#config").val(),
            "type": modalId.find("#type").val(),
            "assignedToValue": modalId.find("#assignedTo").val(),
            "dueDate": modalId.find("#dueDate").val(),
            "details": modalId.find("#details").val(),
            "comments": modalId.find("#comments").val(),
            "alertId": modalId.find("#alertId").val(),
            "appType": modalId.find("#appType").val(),
            "exeConfigId": modalId.find("#exeConfigId").val(),
            "meetingId": modalId.find("#meetingElement").val(),
            "actionStatus": modalId.find("#actionStatus").val(),
            "actionId": modalId.find("#actionId").val()
        }
    };

    var clear_errors = function() {
        $('#createActionModal .modal-body .alert').remove()
    };

    var clear_edit_errors = function () {
        $('#action-edit-modal .modal-body .alert').remove()
    };
    var clear_edit_signal = function () {
        $('#editActionModal .modal-body .alert').remove()
    };

//Single and Aggregate Action list data
    var set_action_list_modal = function(comp) {
        $(document).on('click', '.list-action', function(evt) {
            evt.preventDefault();
            comp.modal('toggle', $(this));
        });
        comp.on('shown.bs.modal', function(evt) {
            var srcEle = evt.relatedTarget;
            var alertId = $(srcEle).attr('data-id');
            var appType = $("#createActionModal #tempForm").find("#appType").val();
            var actionUrl = "/signal/action/listByAlert?alertId=" + alertId +"&appType=" + appType;
            action_list_table = $('#action-table').DataTable({
                destroy : true,
                "language": {
                    "url": "../assets/i18n/dataTables_" + userLocale + ".json"
                },
                fnDrawCallback: function () {
                    $('.edit-action-link').click(function(evt) {
                        var url = "/signal/action/getById?id=" + $(this).attr('data-id');
                        $.ajax({
                            url: url,
                            async: false,
                            cache: false
                        }).done(function(data) {
                            data.action_types = action_select_values.types;
                            data.action_configs = action_select_values.configs;
                            data.all_status = action_select_values.allStatus;
                            data.alertId = alertId;
                            data.actionStatus = {name: data.actionStatus};

                            var html_content = signal.utils.render('action_editor', data);
                            $('#action-editor-container').html(html_content);
                            $('#action-editor-container #due-date-picker').datepicker({
                                date: data.dueDate
                            }).keydown(preventEnterKeySubmit);

                            var dueDate = moment(data.dueDate, "DD-MMM-YYYY").format(DEFAULT_DATE_FORMAT);
                            $('#action-editor-container').find('#due-date-picker').find('#dueDate').val(dueDate);
                            $('#action-editor-container').find('#appType').val(appType);
                            var action_editor = $('#action-editor-container');
                            var editActionModal = $('#action-edit-modal');
                            editActionModal.find('.id-element').attr('data-id', alertId);
                            editActionModal.find('.assignedToValue').val(null).trigger('change');
                            $('#action-modal').modal('hide');
                            editActionModal.modal({});

                            $('#action-edit-modal #cancel-bt').click(handle_action_editor_cancel);
                            $('#action-edit-modal #update-bt').click(handle_action_editor_update)
                        })
                    })
                },
                "fnInitComplete": function(oSettings, json) {
                    $('.action-create').attr('data-id', alertId);
                    signal.actions_utils.set_action_create_modal();
                    $('#due-date-picker').datepicker()
                },
                "ajax": {
                    "url": actionUrl,
                    cache:false,
                    "dataSrc": ""
                },
                "searching": true,
                "bProcessing": true,
                "bLengthChange": true,
                "oLanguage": {
                    "sProcessing": '<div class="grid-loading"><img src="/signal/assets/spinner.gif" width="30" align="middle" /></div>'
                },
                "iDisplayLength": 5,
                "aLengthMenu": [[5, 10, 20, -1], [5, 10, 20, "All"]],
                "aoColumns": [
                    {
                        "mData": "id",
                        "mRender": function (data, type, row) {
                            return "<a href='#' class='edit-action-link' data-id='" +
                                row.id + "'>" + row.id + "<a>"
                        }
                    },
                    {
                        "mData": "type"
                    },
                    {
                        "mData": "config"
                    },
                    {
                        "mData": "details",
                        "className":"col-min-200"
                    },
                    {
                        "mData": "dueDate",
                        "className":"col-min-100"
                    },
                    {
                        "mData": "assignedTo",
                        "className":"col-min-100"
                    },
                    {
                        "mData" : "actionStatus"
                    },
                    {
                        "mData": "completedDate",
                        "className":"col-min-150",
                        mRender: function(data, type,row){
                            return row.completedDate
                        }
                    }
                ],
                scrollX: true,
                columnDefs: [{
                    "targets": '_all',
                    "render": $.fn.dataTable.render.text()
                }]
            })
        });

        comp.on('hidden.bs.modal', function(evt) {
          comp.find("#action-table").empty();
         });
        return action_list_table
    };
    var setEditModalValues = function (editActionModal, data) {
        var actionType = data.typeObj.id;
        var meetingId = data.meetingId;
        var option = new Option(data.assignedToObj.fullName, data.assignedToObj.id, true, true);
        editActionModal.find("#assignedTo").append(option).trigger('change');
        if(!meetingId) {
            editActionModal.find("#type").val(actionType)
        } else {
            editActionModal.find("#meetingElement").val(meetingId);
            editActionModal.find("#meetingValue").val(meetingId);
        }
        editActionModal.find(".status-icon").removeClass('hidden');
        editActionModal.find("#config").val(data.configObj.id);
        editActionModal.find("#actionId").val(data.id);
        var dueDate = moment(data.dueDate, DEFAULT_DATE_FORMAT).format(DEFAULT_DATE_FORMAT);
        editActionModal.find("#due-date-picker").datepicker({
            date: $("#due-date-picker").val() ? new Date($("#due-date-picker").val()) : null,
            momentConfig: {
                culture: userLocale,
                format: DEFAULT_DATE_DISPLAY_FORMAT
            }
        }).keypress(preventEnterKeySubmit);
        editActionModal.find("#dueDate").val(dueDate);
        editActionModal.find("#comments").val(data.comments);
        editActionModal.find("#details").val(data.details);
        editActionModal.find("#actionStatus").val(data.actionStatus);
        editActionModal.find('.action-value').trigger('change');
    };
    var handle_action_editor_cancel = function(evt) {
        evt.preventDefault();
        var action_list_table = $('#action-table').DataTable();
        action_list_table.ajax.reload();
        $('#action-edit-modal').modal('hide')
    };

    var handle_action_editor_update = function(evt) {
        evt.preventDefault();
        if (!evt.handled) {
            evt.handled = true;
            var json = $('#action-editor-container form#action-editor-form').serialize() + "&appType=" + $("#appType").val() + "&exeConfigId=" + $("#exeConfigId").val();

            $.ajax({
                url: '/signal/action/updateAction',
                method: 'POST',
                data: json,
                async: false,
                cache: false,
                success: function(response) {
                    if (response.status == false) {
                        clear_edit_errors();
                        var errorMsg = "<div class='alert alert-danger'>";
                        for(var index = 0; index < response.data.length; index++) {
                            var errorMessageObj = response.data[index];
                            errorMsg += errorMessageObj;
                            errorMsg += '</br>';
                        }
                        errorMsg += "</div>";
                        $('#action-edit-modal .modal-body').prepend(errorMsg)
                    } else {
                        var action_list_table = $('#action-table').DataTable()
                        action_list_table.ajax.reload()
                        //Refresh the activity table
                        if(typeof applicationLabel != 'undefined' && applicationLabel !== APPLICATION_LABEL.CASE_DETAIL && applicationLabel !== APPLICATION_LABEL.EVENT_DETAIL) {
                            signal.activities_utils.reload_activity_table();
                        }
                        $('#action-edit-modal').modal('hide')
                    }

                }
            })
        }
    }
    //Ad-hoc alert action list data
    var init_action_table = function (table_id, appType) {

        var dataUrl = "/signal/action/listByAlert?alertId=" + alertId +"&appType=" + appType;
        adhoc_validated_table = $(table_id).DataTable({
            //"sPaginationType": "bootstrap",

            "language": {
                "url": "../assets/i18n/dataTables_" + userLocale + ".json"
            },

            fnDrawCallback: function () {
                $('.edit-action-link').click(function(evt) {
                    var url = "/signal/action/getById?id=" + $(this).attr('data-id')
                    $.ajax({
                        url: url,
                        async: false,
                        cache: false
                    }).done(function(data) {
                        if(appType == "Signal Management" || appType == "Topic") {
                            var editActionModal = $('#editActionModal');
                            setEditModalValues(editActionModal, data);
                            editActionModal.modal({});
                            editActionModal.find('.update-action').unbind().click(function () {
                                var actionModalId = $("#editActionModal #tempForm");
                                var url;
                                if ($('.meeting-decider').val() == 'true') {
                                    url = '/signal/action/updateMeetingAction';
                                } else {
                                    url = '/signal/action/updateAction';
                                }
                                $.ajax({
                                    url: url,
                                    method: 'POST',
                                    data: getActionDetails(actionModalId),
                                    async: false,
                                    cache: false,
                                    success: function (response) {
                                        if (response.status == false) {
                                            clear_edit_signal();
                                            var errorMsg = "<div class='alert alert-danger'>";
                                            for(var index = 0; index < response.data.length; index++) {
                                                var errorMessageObj = response.data[index];
                                                errorMsg += errorMessageObj;
                                                errorMsg += '</br>';
                                            }
                                            errorMsg += "</div>";
                                            $('#editActionModal .modal-body').prepend(errorMsg)
                                        } else {
                                            $('#action-table').DataTable().ajax.reload();
                                            $('#meeting-table').DataTable().ajax.reload();

                                            //Refresh the activity table
                                            if(typeof applicationLabel != 'undefined' && applicationLabel !== APPLICATION_LABEL.CASE_DETAIL && applicationLabel !== APPLICATION_LABEL.EVENT_DETAIL) {
                                                signal.activities_utils.reload_activity_table();
                                            }
                                            editActionModal.modal('hide');
                                        }
                                    }
                                })
                            });
                        } else {
                            data.action_types = action_select_values.types;
                            data.action_configs = action_select_values.configs;
                            data.all_status = action_select_values.allStatus;
                            data.alertId = alertId;
                            data.actionStatus = {name: data.actionStatus};
                            var html_content = signal.utils.render('action_editor', data);
                            var action_editor = $('#action-editor-container');
                            action_editor.html(html_content);
                            $('#action-editor-container #due-date-picker').datepicker({
                                date: data.dueDate,
                                momentConfig: {
                                    culture: userLocale,
                                    tz: userTimeZone,
                                    format: DEFAULT_DATE_DISPLAY_FORMAT
                                }
                            }).keydown(preventEnterKeySubmit);
                            action_editor.find('#due-date-picker').find('#dueDate').val(data.dueDate);
                            action_editor.find('#due-date-picker').datepicker();
                            var editActionModal = $('#action-edit-modal');
                            editActionModal.find('.id-element').attr('data-id', alertId);
                            editActionModal.modal({});
                            $('#action-editor-container').find('#appType').val(appType);
                            $('#action-edit-modal #cancel-bt').click(handle_action_editor_cancel);
                            $('#action-edit-modal #update-bt').click(handle_action_editor_update)
                        }

                    })
                })

            },
            "fnInitComplete": function(oSettings, json) {
                $('.action-create').attr('data-id', alertId)
                signal.actions_utils.set_action_create_modal()
                $('#due-date-picker').datepicker()
            },
            "ajax": {
                "url": dataUrl,
                cache: false,
                dataSrc: ""
            },
            searching: true,
            dom: 'Bfrtip',
            buttons: [
                {
                    text: 'New Action',
                    className: 'btn-primary action-create',
                    action: function ( e, dt, node, config ) {
                    }
                }
            ],
            aaSorting: [[0, "desc"]],
            "bLengthChange": true,
            "iDisplayLength": 10,
            "aLengthMenu": [[10, 20, 50, -1], [10, 20, 50, "All"]],
            "aoColumns": [
                {
                    "mData": "id",
                    mRender: function(data, type, row) {
                        return "<a href='#' class='edit-action-link' data-id='" +
                            row.id + "'>" + row.id + "<a>"
                    },
                    "className": ""
                },
                {
                    "mData": "type",
                    "className": "",
                    "mRender": function (data, type, row) {
                        return "<span class='word-wrap-break-word'>" + escapeHTML(row.type) + "</span>";
                    }
                },
                {
                    "mData": "config",
                    "className": "",
                    "mRender": function (data, type, row) {
                        return "<span class='word-wrap-break-word'>" + escapeHTML(row.config) + "</span>";
                    }
                },
                {
                    "mData": "details",
                    "className": "",
                    "mRender": function (data, type, row) {
                        return "<span class='word-wrap-break-word'>" + escapeHTML(row.details) + "</span>";
                    }
                },
                {
                    "mData": "dueDate",
                    'className': 'col-min-100',
                    mRender: function(data, type, row) {
                        if (!(row.actionStatus === 'Closed' && row.actionStatus === 'Deleted') && row.passDue) {
                            return "<div class='closed'>" + row.dueDate + "</div>"
                        } else {
                            return "<div>" + row.dueDate + "</div>"
                        }
                    }
                },
                {
                    "mData": "assignedTo",
                    mRender: function(data, type, row) {
                        return escapeHTML(row.assignedTo)
                    },
                    "className": "col-min-150"
                },
                {
                    "mData": "",
                    mRender: function(data, type, row) {
                        return row.actionStatus
                    },
                    "className": ""
                },
                {
                    "mData": "completedDate",
                    mRender: function(data, type,row){
                        return row.completedDate
                    },
                    "className": "col-min-150"
                }
            ],
            scrollX : true
        });
        adhoc_validated_table.button().disable();
        return adhoc_validated_table
    };

    var build_action_render = function(data) {
        var action_drop_down_html = signal.utils.render("action_drop_down", data);
        return action_drop_down_html
    };
    var reload_action_table = function () {
        if (typeof adhoc_validated_table != "undefined" && adhoc_validated_table != null) {
            adhoc_validated_table.ajax.reload();
        } else {
            console.log("Unable to reload the activity table. Please refresh the page.")
        }
    };

    return {
        set_action_list_modal: set_action_list_modal,
        set_action_create_modal: set_action_create_modal,
        build_action_render: build_action_render,
        init_action_table: init_action_table,
        reload_action_table : reload_action_table,
        handle_action_editor_cancel: handle_action_editor_cancel,
        handle_action_editor_update: handle_action_editor_update,
        clear_edit_errors: clear_edit_errors
    }
})();

var signal = signal || {};

var meetingDataTable;
var schedulerDataJson;

signal.meeting_utils = (function () {


    var current_create_bt
    var table
    var set_meeting_create_modal = function () {
        $('#createMeetingModal').on('shown.bs.modal', function (e) {
            $(this).find('.clear-field').val('');
            $('#meetingAttendees-create').select2("val", "");
            clear_errors();
            processScheduler('create');
        });
        $('#createMeetingModal').on('hidden.bs.modal', function (e) {
            unProcessScheduler('create');
            $('.meetingSuggestionContainer').collapse('hide');
        });

        $('#editMeetingModal').on('shown.bs.modal', function (e) {
            clear_errors();
            processScheduler('edit', schedulerDataJson);
        });
        $('#editMeetingModal').on('hidden.bs.modal', function (e) {
            unProcessScheduler('edit');
            $('.meetingSuggestionContainer').collapse('hide');
        });

        $('.meeting-create').click(function (evt) {

            var srcEle = $(evt.target)
            current_create_bt = srcEle
            var alertId = alertId
            if (typeof (srcEle.attr('alert-id')) !== 'undefined') {
                alertId = srcEle.attr('alert-id')
            }

            var createMeetingModal = $('#createMeetingModal')
            createMeetingModal.find('.id-element').attr('data-id', alertId);

            //Set the alertId in the hidden field of the modal.
            if (typeof alertId != "undefined" && alertId != '') {
                createMeetingModal.find(".alertId").val(alertId);
            }

            //createMeetingModal.find('#due-date-picker').datepicker()

            clear_errors();
            $('.isRecurringMeeting').removeAttr("checked");
            $('.isRecurringMeeting').trigger("change");
            createMeetingModal.modal({});

            showTagWidget("#meetingAttendees-create");

            //Event bind when the save/create button is clicked in the action event modal.
            $("#create-meeting-btn,#create-iCalander").click(function (event) {
                if (!event.handled) {
                    var icsFile = $(this).data('icsFile');
                    var alertId = $(event.target).attr('data-id');
                    event.handled = true;
                    var appType = $("#appType").val();
                    var meetingModal = $("#createMeetingModal #tempForm");
                    $.ajax({
                        type: "POST",
                        url: '/signal/meeting/save?downloadICSFile=' + icsFile,
                        data: getMeetingDetails(meetingModal, 'create'),
                        async: false,
                        processData: false,
                        contentType: false,
                        dataType: 'json',
                        cache: false
                    }).success(function (payload) {
                        if (payload.status) {
                            downloadICSFile(icsFile, payload.data);
                            createMeetingModal.find('.form-control').val("");
                            $('#meeting-table').DataTable().ajax.reload();
                            createMeetingModal.modal('hide');
                            //Refresh the activity table
                            signal.activities_utils.reload_activity_table();
                            signal.actions_utils.reload_action_table();
                            signal.meeting_utils.reload_meeting_table();

                        } else {
                            clear_errors();
                            var errorMsg;
                            if (payload.code == 400)
                                errorMsg = showErrorMessageInMeetingModal("Entered Email address is not valid");
                            else
                                errorMsg = showErrorMessageInMeetingModal("Please provide value for all the mandatory fields");
                            $('#createMeetingModal .modal-body').prepend(errorMsg)
                        }
                    }).error(function (data) {
                        clear_errors()
                        var errorMsg = showErrorMessageInMeetingModal(data.responseText);
                        $('#createMeetingModal .modal-body').prepend(errorMsg)
                    })
                }
            })

        })
    }

    var getMeetingDetails = function (modalId, text) {
        var meetingMinutes = "";
        var data = new FormData();
        if (modalId.find("#meetingMinutes").val()) {
            meetingMinutes = modalId.find("#meetingMinutes").val();
            data.append('meetingMinutes', meetingMinutes);
        }
        if(text !== 'meetingMinutes'){
            var attendeesArray = modalId.find("#meetingAttendees-" + text).val();
            if (attendeesArray) {
                data.append('meetingAttendees', attendeesArray.toString());
            }
            data.append('scheduleDateJSON', JSON.stringify($('#myScheduler').scheduler('value')));
            data.append('isRecurringMeeting', modalId.find("#isRecurringMeeting").is(":checked"));
            data.append('duration', modalId.find("#duration").val());
            data.append('meetingAgenda', modalId.find("#meetingAgenda").val());
            data.append('meetingOwner', modalId.find("#meetingOwner").val());
            var dateTime = modalId.find("#meetingDate").val() + " " + modalId.find("#meetingTime").val();
            data.append('meetingDate', dateTime);
            data.append('meetingTitle', modalId.find("#meetingTitle").val());
        }
        data.append('type', modalId.find("#type").val());
        data.append('appType', modalId.find("#appType").val());
        data.append('alertId', modalId.find("#alertId").val());
        data.append('attachmentSize', modalId.find("#attachments").prop('files').length);
        for (var i = 0; i < modalId.find("#attachments").prop('files').length; i++) {
            data.append('attachments' + i, modalId.find("#attachments").prop('files')[i]);
        }
        return data
    }

    var clear_errors = function () {
        $('.modal .modal-body .alert').remove();
    }

    var fillModalDataWithText =  function(data,modal,isEditSeries,text){
        var meetingAttendees = data.attendees;
        var attendees = "";
        clearModal(modal);
        var attendeesList = [];
        for (var i = 0; i < meetingAttendees.length; i++) {
            if (i == 0) {
                attendees = meetingAttendees[i].id
                attendeesList.push(meetingAttendees[i].id);
            } else {
                attendees = attendees + "," + meetingAttendees[i].id;
                attendeesList.push(meetingAttendees[i].id);
            }
        }
        var span = ""
        for (var i = 0; i < data.meetingAttachments.length; i++) {

            var link = "/signal/meeting/viewAttachments?attachmentId=" + data.meetingAttachments[i].id + "&meetingId=" + data.id
            span = span + "<a class='attachment-name m-t-15' target='_blank' href='" + link + "' download='" + data.meetingAttachments[i].name +
                "'> <i class='fa fa-file m-r-10' aria-hidden='true'> </i>" + data.meetingAttachments[i].name + "</a></div>"
        }
        modal.find(".attachments .attachment-body").html(span)

        modal.find('.id-element').attr('data-id', alertId);
        modal.find('.meeting-id-element').attr('data-is-edit-series', isEditSeries);
        if (isEditSeries) {
            modal.find('.meeting-id-element').attr('data-master-id', data.masterId);
            $('#cancelMeetingLink').hide();
            $('#cancelMeetingSeriesLink').show();
            modal.find('.recurrence-checkbox-container').show();
            $('#edit-meeting-title-container').text('Edit Series');
            $('.isRecurringMeeting').attr("checked","checked");
            $(".meetingDate").attr("disabled", "disabled");
            $(".meetingTime").attr("disabled", "disabled");
            $('.schedular-container').collapse('show');
        } else {
            modal.find('.meeting-id-element').attr('data-meeting-id', data.id);
            $('#cancelMeetingLink').show();
            $('#cancelMeetingSeriesLink').hide();
            modal.find('.recurrence-checkbox-container').hide();
            $('#edit-meeting-title-container').text('Edit Meeting');
            $('.isRecurringMeeting').removeAttr("checked");
            $(".meetingDate").removeAttr("disabled");
            $(".meetingTime").removeAttr("disabled");
            $('.schedular-container').collapse('hide');
        }
        modal.find("#meetingTitle").val(data.meetingTitle);
        modal.find("#meetingOwner").val(data.ownerId);
        modal.find("#meetingDate").val(moment(data.meetingDate,"DD-MMM-YYYY h:mm A").format('MM/DD/YYYY'));
        modal.find("#meetingTime").val(moment(data.meetingDate,"DD-MMM-YYYY h:mm A").format('HH:mm'));
        modal.find('#due-date-picker').datepicker();
        $("#meetingAttendees-" + text).find("option[isGuest='true']").remove();
        modal.find("#meetingAgenda").val(data.meetingAgenda);
        if (data.guestAttendees) {
            $.each(data.guestAttendees, function (index, value) {
                modal.find("#meetingAttendees-"+text).append("<option value='" + value + "' isGuest='true'>" + value + "</option>");
                attendeesList.push(value);
            });
        }
        modal.find("#meetingAttendees-"+text).val("");
        modal.find('#meetingAttendees-'+text).find('option.guestAttendee').remove();
        modal.find("#meetingAttendees-"+text).val(attendeesList);
        showTagWidget("#meetingAttendees-"+text);
        modal.find('#duration').val(data.duration);
    };

    var fillModalData = function (data, modal, isEditSeries) {
        fillModalDataWithText(data,modal,isEditSeries,'edit')
    };

    var init_meeting_table = function (table_id) {
        var dataUrl = "/signal/meeting/list?alertId=" + alertId + "&appType=" + appType;
        table = $(table_id).DataTable({
            "language": {
                "url": "../assets/i18n/dataTables_" + userLocale + ".json"
            },
            fnDrawCallback: function () {
                var appType = $("#appType").val();
                colEllipsis();
                webUiPopInit();

                $('.edit-meeting-series-link').click(function (evt) {
                    var editMeetingSeriesModal;
                    var masterMeetingId = $(this).attr('data-master-id');
                    var url = "/signal/meeting/getByMasterId?masterId=" + masterMeetingId;
                    $.ajax({
                        url: url,
                        async: false,
                        cache: false
                    }).success(function (data) {
                        schedulerDataJson = JSON.parse(data.schedularJson);
                        editMeetingSeriesModal = $('#editMeetingModal');
                        fillModalData(data, editMeetingSeriesModal, true);
                        editMeetingSeriesModal.modal({});
                    });
                    $('.update-meeting,#edit-iCalander').unbind().click(function (evt) {
                        var icsFile = $(this).data('icsFile');
                        var updateUrl = "/signal/meeting/updateMeetingSeries?masterId=" + masterMeetingId + "&appType=" + appType + "&downloadICSFile=" + icsFile;
                        var editMeetingModalForm = $("#editMeetingModal #tempForm");
                        $.ajax({
                            url: updateUrl,
                            type: "POST",
                            data: getMeetingDetails(editMeetingModalForm, 'edit'),
                            async: false,
                            processData: false,
                            contentType: false,
                            dataType: 'json',
                            cache: false
                        }).success(function (payload) {
                            if (payload.status) {
                                downloadICSFile(icsFile, payload.data);
                                editMeetingModalForm.find('.form-control').val("");
                                editMeetingModalForm.find("#attachments").val("");
                                editMeetingSeriesModal.modal("hide");
                                signal.activities_utils.reload_activity_table();
                                signal.actions_utils.reload_action_table();
                                signal.meeting_utils.reload_meeting_table();
                            } else {
                                clear_errors();
                                var errorMsg;
                                if (payload.code == 400)
                                    errorMsg = showErrorMessageInMeetingModal("Entered Email address is not valid");
                                else
                                    errorMsg = showErrorMessageInMeetingModal("Please provide value for all the mandatory fields");
                                editMeetingSeriesModal.find('.modal-body').prepend(errorMsg);
                            }
                        })
                    })

                });

                $('.add-meeting-minutes-link').click(function (evt) {
                    var mmModal = $('#meetingMinutesModal');
                    var url = "/signal/meeting/getById?meetingId=" + $(this).attr('data-id');
                    var meetingId = $(this).attr('data-id');
                    var $form = $('#meetingModalForm');
                    $.ajax({
                        url: url,
                        async: false,
                        cache: false,
                        dataType: 'json'
                    }).success(function (data) {
                        var $meetingMinutes = $('.meetingMinutes');
                        fillModalDataWithText(data,mmModal,false,'meeting-minutes');
                        fillModalData(data, mmModal, false);
                        disableFormFields($form);
                        $meetingMinutes.removeAttr('disabled');
                        $meetingMinutes.val(data.meetingMinutes);
                        mmModal.modal({});
                    });
                    $('.update-meeting').unbind().click(function (evt) {
                        var appType = $('#meetingModalForm #appType').val();
                        var alertId = $('#meetingModalForm #alertId').val();
                        var updateUrl = "/signal/meeting/saveMeetingMinutes?meetingId=" + meetingId;
                        $.ajax({
                            url: updateUrl,
                            type: "POST",
                            data: getMeetingDetails(mmModal, 'meetingMinutes'),
                            async: false,
                            processData: false,
                            contentType: false,
                            dataType: 'json',
                            cache: false
                        }).success(function (data) {
                            mmModal.find('.form-control').val("");
                            mmModal.find("#attachments").val("");
                            mmModal.modal("hide");
                            signal.activities_utils.reload_activity_table();
                            signal.actions_utils.reload_action_table();
                            table.ajax.reload();
                        })
                    })
                });

                $('.edit-meeting-link').click(function (evt) {
                    var editMeetingModal;
                    var url = "/signal/meeting/getById?meetingId=" + $(this).attr('data-id');
                    var meetingId = $(this).attr('data-id');
                    $.ajax({
                        url: url,
                        async: false,
                        cache: false
                    }).success(function (data) {
                        editMeetingModal = $('#editMeetingModal');
                        fillModalData(data, editMeetingModal, false);
                        editMeetingModal.modal({})
                    }).error(function (data) {
                        clear_errors();
                        var errorMsg = showErrorMessageInMeetingModal(data.responseText);
                        $('#editMeetingModal .modal-body').prepend(errorMsg)
                    });

                    $('.update-meeting,#edit-iCalander').unbind().click(function (evt) {
                        var icsFile = $(this).data('icsFile');
                        var updateUrl = "/signal/meeting/updateMeeting?meetingId=" + meetingId + "&downloadICSFile=" + icsFile;
                        var editMeetingModalForm = $("#editMeetingModal #tempForm");
                        $.ajax({
                            url: updateUrl,
                            type: "POST",
                            data: getMeetingDetails(editMeetingModalForm, 'edit'),
                            async: false,
                            processData: false,
                            contentType: false,
                            dataType: 'json',
                            cache: false
                        }).success(function (payload) {
                            if(payload.status){
                                downloadICSFile(icsFile, payload.data);
                                editMeetingModalForm.find('.form-control').val("");
                                editMeetingModalForm.find("#attachments").val("");
                                editMeetingModal.modal("hide");
                                signal.activities_utils.reload_activity_table();
                                signal.actions_utils.reload_action_table();
                                signal.meeting_utils.reload_meeting_table();
                            }else {
                                clear_errors();
                                var errorMsg;
                                if (payload.code == 400)
                                    errorMsg = showErrorMessageInMeetingModal("Entered Email address is not valid");
                                else
                                    errorMsg = showErrorMessageInMeetingModal("Please provide value for all the mandatory fields");
                                editMeetingModal.find('.modal-body').prepend(errorMsg);
                            }
                        })
                    })

                })
            },
            "fnInitComplete": function (oSettings, json) {
                $('.meeting-create').attr('data-id', alertId)
                signal.meeting_utils.set_meeting_create_modal();
                $('#due-date-picker').datepicker()
            },
            "ajax": {
                "url": dataUrl,
                cache: false,
                dataSrc: ""
            },
            searching: true,
            dom: "Bfrtip",
            buttons: [
                {
                    text: 'New Meeting',
                    className: 'btn-primary meeting-create',
                    action: function (e, dt, node, config) {
                    }
                }
            ],
            aaSorting: [[6, "desc"]],
            "bLengthChange": true,
            "iDisplayLength": 10,
            "aLengthMenu": [[10, 20, 50, -1], [10, 20, 50, "All"]],
            "aoColumns": [
                {
                    "mData": "meetingTitle",
                    mRender: function (data, type, row) {
                        var date = moment(row.meetingDate, 'DD-MMM-YYYY').format('DD-MMM-YYYY');
                        var title = escapeHTML(row.meetingTitle);
                        if (row.isRecurrenceMeeting) {
                            title += "(" + date + ")";
                        }
                        if (row.meetingStatus == "CANCELLED") {
                            title += "(" + row.meetingStatus + ")";
                        }
                        var actionButton = '<div class="btn-group dropdown dataTableHideCellContent" align="left"> \
                            <a class="dropdown-toggle" data-toggle="dropdown"> \
                                ' + title + '<span class="sr-only">Toggle Dropdown</span> \
                            </a> \
                            <ul class="dropdown-menu" role="menu" style="min-width: 80px !important; font-size: 12px;">';
                        if (row.isMeetingEditable) {
                            actionButton += '<li role="presentation"><a class="edit-meeting-link" role="menuitem"  data-id="' + row.id + '" href="#" >' + 'Edit Meeting' + '</a></li>';
                            if (row.isRecurrenceMeeting) {
                                actionButton += '<li role="presentation"><a class="edit-meeting-series-link" role="menuitem"  data-master-id="' + row.masterId + '" href="#" >' + 'Edit Series' + '</a></li>';
                            }
                        }
                        actionButton += '<li role="presentation"><a class="add-meeting-minutes-link" role="menuitem" data-id="' + row.id + '" href="#" >' + 'Add Minutes' + '</a></li>';
                        actionButton += '</ul></div>';
                        return actionButton;
                    }

                },
                {
                    "mData": "meetingDate",
                    mRender: function (data, type, row) {
                        return moment(data,"DD-MMM-YYYY").format("dddd") + " " + moment(data,"DD-MMM-YYYY h:mm A").format("DD-MMM-YYYY h:mm A");
                    }
                },
                {
                    "mData": "meetingMinutes",
                    'className':'col-min-150 cell-break col-max-200',
                    "mRender" : function(data, type, row) {
                        return addEllipsis(row.meetingMinutes);

                    }

                },
                {
                    "mData": "meetingOwner"
                }, {
                    "mData": "meetingAgenda",
                    'className':'col-min-150 col-max-300 cell-break ',
                    "mRender" : function(data, type, row) {
                        return addEllipsis(row.meetingAgenda);

                    }
                },
                {
                    "mData": "modifiedBy"
                },
                {
                    "mData": "lastModified"
                },
                {
                    "mData": "",
                    mRender: function (data, type, row) {
                        if (row.actionStatus == 3) {
                            return '<img src="' + "/signal/assets/icons/high_priority.png" + '"/>';
                        } else if (row.actionStatus == 2) {
                            return '<img src="' + "/signal/assets/icons/medium_priority.png" + '"/>';
                        } else if (row.actionStatus == 1) {
                            return '<img src="' + "/signal/assets/icons/low_priority.png" + '"/>';
                        } else {
                            return '';
                        }
                    }
                }

            ],
            scrollX:true,
            scrollY:'270px',
            columnDefs: [{
                "targets": '_all',
                "render": $.fn.dataTable.render.text()
            }]
        });
        table.button().disable();
        meetingDataTable = table;
        return table
    }

    var reload_meeting_table = function () {
        meetingDataTable.ajax.reload();
    };

    return {
        set_meeting_create_modal: set_meeting_create_modal,
        init_meeting_table: init_meeting_table,
        reload_meeting_table: reload_meeting_table
    }
})();

function showErrorMessageInMeetingModal(text) {
    var errorMsg = "<div class='alert alert-danger'>";
    if (text) {
        errorMsg += text;
    } else {
        errorMsg += 'Please fill  the required Fields';
    }
    errorMsg += "</div>";
    return errorMsg;
}

$(document).on('click', '.closeMeetingModal', function (e) {
    bootbox.confirm({
        message: "There are unsaved changes for this meeting. Do you still want to close it?",
        buttons: {
            confirm: {
                label: 'Yes',
                className: 'btn-primary'
            },
            cancel: {
                label: 'No',
                className: 'btn-default'
            }
        },
        callback: function (result) {
            bootbox.hideAll();
            if (result) {
                $('#createMeetingModal').modal('hide');
            }
        }
    });
});

function clearModal($modal) {
    $modal.find("input[type=text]").val('');
    $modal.find("textarea").val('');
}

function disableFormFields($form) {
    $form.find('select').attr('disabled', true);
    $form.find('textarea').attr('disabled', true);
    $form.find('.searchMeetingTimes').addClass('disabled');
}

$(document).on('change', ".isRecurringMeeting", function () {
    if ($(this).is(":checked")) {
        $('.schedular-container').collapse('show');
        $(".meetingDate").attr("disabled", "disabled");
        $(".meetingTime").attr("disabled", "disabled");
    } else {
        $('.schedular-container').collapse('hide');
        $(".meetingDate").removeAttr("disabled");
        $(".meetingTime").removeAttr("disabled");
    }
});

function intializeSchedular() {
    $('.myScheduler').scheduler('value', {
        startDateTime: new Date().toISOString(),
        timeZone: {
            // offset: '+05:30',
            name: "Asia/Kolkata"
        },
        recurrencePattern: 'BYDAY=MO'
    });
}

$(document).on('click', '.searchMeetingTimes', function () {
    $(this).find('.time-slot-container').html('');
    $('.meetingSuggestionContainer').collapse('toggle');
});

$(document).on('click', '.findMeetingTimes', function () {
    $(this).find('.time-slot-container').html('');
    var text = $(this).data('text');
    var $modal;
    if (text == 'create') {
        $modal = $('#createMeetingModal');
    } else {
        $modal = $('#editMeetingModal');
    }
    var myData = {
        fmtStartDate: $('#fmtStartDate-' + text).val(),
        fmtEndDate: $('#fmtEndDate-' + text).val(),
        duration: $('#duration').val()
    };
    var attendeesArray = $modal.find("#meetingAttendees-"+text).val();
    if (attendeesArray) {
        myData.meetingAttendees = attendeesArray.toString()
    }
    var $msgContainer = $modal.find('.modal-body').find('#msg-container');
    $.ajax({
        type: "POST",
        url: $("#findMeetingTimesUrl").val(),
        data: $.param(myData),
        dataType: 'json',
        success: function (payload) {
            if (payload.status) {
                $msgContainer.hide();
                showTimeSuggestions(payload.data);
                $('.meetingSuggestionContainer').collapse('show');
            } else {
                var errorMsg = showErrorMessageInMeetingModal(payload.message);
                $msgContainer.html(errorMsg);
                $msgContainer.show();
                $('.time-slot-container').html('');
            }
        }
    });
});

$(document).on('click', '.selectTimeSlot', function () {
    $('.meetingDate').val($(this).data('startDate'));
    $('.meetingTime').val($(this).data('startTime'));
    $('.meetingSuggestionContainer').collapse('hide');
});

function showTimeSuggestions(data) {
    var suggestionList;
    if (data) {
        suggestionList = data.meetingTimeSuggestions;
    }
    var generatedHtml = "";
    var startDate;
    var startTime;
    if (suggestionList) {
        $.each(suggestionList, function (index, value) {
            startDate = moment(value.timeSlot.startDateTime).format('MM/DD/YYYY');
            startTime = moment(value.timeSlot.startDateTime).format('HH:mm:ss');
            generatedHtml += '<div class="panel panel-warning meeting-slot-container">' +
                '<div class="panel-body">' +
                '<div class="meeting-suggestion row">' +
                // '<div class="col-md-3">'
                // + value.attendees[0].email+
                // '</div>' +
                '<div class="col-md-4">'
                + moment(value.timeSlot.startDateTime).format('DD-MMM-YYYY') + ' '
                + startTime +
                '</div>' +
                '<div class="col-md-4">'
                + moment(value.timeSlot.endDateTime).format('DD-MMM-YYYY') + ' '
                + moment(value.timeSlot.endDateTime).format('HH:mm:ss') +
                '</div>' +
                '<div class="col-md-4">' +
                '<a class="btn btn-primary selectTimeSlot" data-start-date="' + startDate + '" data-start-time="' + startTime + '">Select</a></div>' +
                '</div></div></div>';
        });
    } else {
        generatedHtml += '<div class="panel panel-warning meeting-slot-container">' +
            '<div class="panel-body">No Time Slot found for given date.</div></div>'
    }
    $('.time-slot-container').html(generatedHtml);
}

$(document).on('click', '.cancelMeetingLink', function (e) {
    e.preventDefault();
    var isEditSeries = $(this).data('isEditSeries');
    var url;
    if (isEditSeries) {
        url = $(this).attr('href') + "?masterId=" + $(this).data('master-id');
    } else {
        url = $(this).attr('href') + "&id=" + $(this).data('meeting-id');
    }
    $.ajax({
        type: "POST",
        url: url,
        data: {},
        dataType: 'json',
        success: function (data) {
            $("#editMeetingModal").modal('hide');
            signal.activities_utils.reload_activity_table();
            signal.actions_utils.reload_action_table();
            meetingDataTable.ajax.reload();
        }
    });
});

function processScheduler(text, json) {
    var $schedularContainer = $('#schedularContainer');
    var html = $schedularContainer.html();
    $('.schedular-container-' + text).html(html);
    $schedularContainer.html('');
    initializeScheduler(json);
}

function unProcessScheduler(text) {
    var $schedulerClassContainer = $('.schedular-container-' + text);
    var html = $schedulerClassContainer.html();
    $('#schedularContainer').html(html);
    $schedulerClassContainer.html('');
}

function initializeScheduler(value) {
    $('#myScheduler').scheduler();
    if ((typeof value === 'undefined' || value === null)) {
        setToday();
    } else {
        $('#myScheduler').scheduler('value', {
            startDateTime: value.startDateTime,
            timeZone: {
                // name: value.timeZone.name,
                offset: value.timeZone.offset
            },
            recurrencePattern: value.recurrencePattern
        })
        var newInfo = $('#myScheduler').scheduler('value');
        $('#configSelectedTimeZone').val(newInfo.timeZone.name);
        for (var i = 0; i < 24; i++) {
            var min = 0;
            for (var j = 0; j < 2; j++) {
                $("#myScheduler #timeSelect ul").append('<li><a href="#">' + calculateAllIntervals(i, min) + '</a></li>');
                min = 30
            }
        }
    }
}

$('#myScheduler').on('changed.fu.scheduler', function (e, data) {
    var newInfo = $('#myScheduler').scheduler('value');
    $('#scheduleDateJSON').val(JSON.stringify(newInfo));
    $('#configSelectedTimeZone').val(newInfo.timeZone.name);
});

$('#myDatePicker').click(function () {
    var currentDate = new Date();
    var selectedDate = $("#MyStartDate").val();
    var schedulerFrom = $('#schedulerFrom').val();


    if (currentDate < new Date(selectedDate)) {
        $("#myScheduler #timeSelect ul").empty();
        for (var i = 0; i < 24; i++) {
            var min = 0;
            for (var j = 0; j < 2; j++) {
                $("#myScheduler #timeSelect ul").append('<li><a href="#">' + calculateAllIntervals(i, min) + '</a></li>');
                min = 30
            }
            $("#myStartTime").val(12 + ':' + "00" + ' ' + 'AM');
        }
    } else {
        setToday()

    }
    var newInfo = $('#myScheduler').scheduler('value');
    $('#scheduleDateJSON').val(JSON.stringify(newInfo));
    $('#configSelectedTimeZone').val(newInfo.timeZone.name);
});
if (document.getElementById("enable")) {
    var enable = $("#enable").val();
    if (enable) {
        $('#schedule *').prop('disabled', true);
    }
}

// scheduleDateJSONDefault = JSON.stringify($('#myScheduler').scheduler('value'));

function calculateNxtInterval(date, interval) {
    var hour = date.getHours() + 0;
    var minute = date.getMinutes() + interval;
    if (minute >= 60) {
        hour = hour + Math.floor(minute / 60);
        minute = minute % 60
    }
    var amPm = hour >= 12 ? "PM" : "AM";
    hour = hour % 12;
    hour = hour ? hour : 12;
    minute = (minute > 9 ? minute : "0" + minute);
    hour = hour > 9 ? hour : "0" + hour;
    var now = hour + ':' + minute + ' ' + amPm;
    return now;
}

function calculateAllIntervals(hour, minute) {
    var amPm = hour >= 12 ? "PM" : "AM";
    hour = hour % 12;
    hour = hour ? hour : 12;
    minute = (minute > 9 ? minute : "0" + minute);
    hour = hour > 9 ? hour : "0" + hour;
    var now = hour + ':' + minute + ' ' + amPm;
    return now;
}

function calculateNumberOfIntervals(hour, min, ampm) {
    var count = (12 - hour) * 2;
    if (ampm == "AM") {
        count = count + 48
    }
    var listCount = min < 30 ? count : count - 1;
    return listCount
}

function setToday() {

    var schedulerTime = $("#schedulerTime").val();
    if (typeof schedulerTime != "undefined") {
        schedulerTime = parseInt(schedulerTime);
    }
    var scheduledDate = new Date(); // get the date time from server
    var now = calculateNxtInterval(scheduledDate, 0);
    var hour = now.split(":")[0];
    var nowMin = now.split(":")[1].split(" ")[0];
    var nxtInterval = nowMin < 30 ? 30 - nowMin : 60 - nowMin;
    $("#time").text(now);
    var count = calculateNumberOfIntervals(hour, nowMin, now.split(":")[1].split(" ")[1]);
    for (var i = 0; i < count - 1; i++) {
        $("#myScheduler #timeSelect ul").append('<li><a href="#">' +
            calculateNxtInterval(scheduledDate, nxtInterval) + '</a></li>');
        nxtInterval += 30
    }

    var prefTimezone = $("#timezoneFromServer").val();

    var timeZoneData = null;
    if (typeof prefTimezone != "undefined" && prefTimezone != null) {
        timeZoneData = prefTimezone.split(",");
    }

    if (timeZoneData) {
        var name = timeZoneData[0].split(":")[1].trim();
        var offset = timeZoneData[1].substring(8).trim();
        $('#myScheduler').scheduler('value', {
            startDateTime: moment(scheduledDate).format("YYYY-MM-DDTHH:mm:ss.sTZD"),
            timeZone: {
                name: name,
                offset: offset
            }
        })
    }


}

function showTagWidget(id) {
    var $tag = $(id);
    $tag.select2({
        tags: true,
        placeholder: "Select Attendees",
        allowClear: true,
        width: "100%",
        createTag: function (params) {
            var term = $.trim(params.term);
            if (term != "") {
                return {
                    id: term,
                    text: term,
                }
            }

            return null
        }
    })

}

function downloadICSFile(icsFile, data) {
    if (icsFile) {
        window.open("data:text/calendar;charset=utf8," + escape(data));
    }
}

//= require app/pvs/common/rx_common.js
//= require app/pvs/common/rx_handlebar_ext.js
//= require app/pvs/common/rx_alert_utils.js
//= require app/pvs/common/rx_list_utils.js
//= require app/pvs/actions/actions.js
//= require app/pvs/meeting/meeting.js

var applicationName = APPLICATION_NAME.SIGNAL_MANAGEMENT;
var applicationLabel = APPLICATION_LABEL.SIGNAL_MANAGEMENT;
var appType = ALERT_CONFIG_TYPE.SIGNAL_MANAGEMENT;
var statusHistoryList = [];

$(document).ready(function () {
    var action_table;
    var meeting_table;

    var init = function () {
        action_table = signal.actions_utils.init_action_table($('#action-table'), appType);
        meeting_table = signal.meeting_utils.init_meeting_table($('#meeting-table'));
        setCreatedDate();
    };

    $(document).on('click', '#signal-history-table .btn-add-row', function (evt) {
        if (!$(this).hasClass('disabled')) {
            var addedStatus = [];
            $('.status').each(function (){
                if(!$(this).prop('disabled') && $(this).is(":visible")){
                    addedStatus.push($(this).val())
                }
            });
            var $signalHistoryRow = $(this).closest('.signalHistoryRow');
            $signalHistoryRow.find('.btn-add-row').remove();
            var $tr = $('.tr_clone');
            var $clone = $tr.clone();
            $clone.removeClass('hidden');
            if ($signalHistoryRow.hasClass('odd')) {
                $clone.addClass('even')
            } else {
                $clone.addClass('odd')
            }
            $clone.find("select[name*='signalStatus'] > option").each(function() {
                if($.inArray($(this).text(), addedStatus ) != -1){
                    $(this).remove();
                }
            });
            $clone.find('.historyDatePicker').datepicker({
                date: null,
                allowPastDates: true,
                momentConfig: {
                    culture: userLocale,
                    tz: userTimeZone,
                    format: DEFAULT_DATE_DISPLAY_FORMAT
                },
                restricted: [{from: TOMORROW , to: Infinity}]
            });
            $tr.after($clone);
        }
    });

    $(document).on('click', '#signal-history-table .save-history', function (evt) {
        //enabling disabled values before ajax call in order to get the values of that field
        $('select[name=signalStatus]').find('option').attr("disabled", false);
        $(this).attr("disabled", true);
        var $tr = $(this).closest('.signalHistoryRow');
        var signalStatus = $tr.find('.status').val();
        var createdDate = $tr.find('.date-created').val();
        var statusComment = $tr.find('.comment').val();
        var signalHistoryId = $tr.find('.signalHistoryId').val();
        if (!signalStatus || !createdDate || !statusComment) {
            $.Notification.notify('warning', 'top right', "Warning", $.i18n._('signalHistory.saveWarning'), {autoHideDelay: 40000});
        } else if(!statusHistoryList.includes(signalStatus + createdDate + statusComment)){
            statusHistoryList.push(signalStatus + createdDate + statusComment);
            $.ajax({
                url: saveSignalStatusHistory,
                data: {
                    'createdDate': createdDate,
                    'statusComment': statusComment,
                    'signalStatus': signalStatus,
                    'signalHistoryId': signalHistoryId,
                    'signalId': $("#signalIdPartner").val()
                },
                success: function (response) {
                    if (response.status) {
                        $('#signalHistory').html(response.data);
                        setCreatedDate();
                        $.Notification.notify('success', 'top right', "Success", $.i18n._('signalHistory.success'), {autoHideDelay: 20000});
                    } else {
                        $.Notification.notify('error', 'top right', "Error", response.message, {autoHideDelay: 20000});
                    }
                    disableOptions(disabledValues);
                }
            })
        }
        $(this).attr("disabled",false);
        disableOptions(disabledValues);
    });

    init();
});

function setCreatedDate() {
    $('.historyDatePicker').each(function () {
        var selectedDate = $(this).find('.date-created').val();
        $(this).datepicker({
            date: selectedDate ? selectedDate : null,
            allowPastDates: true,
            momentConfig: {
                culture: userLocale,
                tz: userTimeZone,
                format: DEFAULT_DATE_DISPLAY_FORMAT
            },
            restricted: [{from: TOMORROW , to: Infinity}]
        })
    });
}

